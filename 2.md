# 統計解析入門1
## データ形式 

###ベクトル

Rに特有のデータ形式の名前です。ベクトルとは，要するに複数の数字などを1つにまとめたものです。
「変数」で代入操作した結果はすべてベクトルです。下の実行例でXはベクトルです。

	> X <- c(3, 6, 8)
	> X
	[1] 3  6  8
		      

###データフレーム 

データフレーム は，Excelなどの表計算ソフトで言うシートに近いものです。たとえばRのコンソールで cars とだけ入力してEnterを押すと，次のような表示が出ます（後半の出力部分は掲載を省略しました）。

	> cars
	   speed dist
	1      4    2
	2      4   10
	3      7    4
	4      7   22
	5      8   16
	6      9   10
	7     10   18
	8     10   26
	9     10   34
	10    11   17		      
		      

左端の数値はデータそのものではなく，データの行数を表してます。列数と行数に制限はありません。
cars データには2つの列があります。speed と dist です（走行速度と停止までの距離）。 このような形式で保存されたデータをRではデータフレームといいます。

###添字

データの順番を表す概念に添字があります。添字を使うと

データフレームから特定の列や行だけを取り出すことができます。
まずデータフレームから特定の列をまるまる取り出すには「$」を使います。

	> cars$speed
	 [1]  4  4  7  7  8  9 10 10 10 11 11 12 12 12 12 13 13 13
	[19] 13 14 14 14 14 15 15 15 16 16 17 17 17 18 18 18 18 19
	[37] 19 19 20 20 20 20 20 22 23 24 24 24 24 25		      
		      

一番左端に[1],[19],[37]というのは，データではありません。その右隣に表示されている数値が，データの何番目の要素であるかを示す表示です。たとえば[19]はその右にある13が，carsデータの speed 列の19番目（carsデータの19行目）の要素であることを意味します。[37]の隣の19は，37番目という意味です。 データの添字ともいいます。

例えば「car$speed」の後ろに「19」をつけてEnterを押すと，cars データの speed 列の19番目の要素だけが表示されます。

	> cars$speed [19]
	[1] 13		      
		      

行数を指定してデータを取り出すには，データフレームの名前の後ろに角括弧をつけます。各括弧の中は「,」で分け，コンマの前が行番号，後ろが列番号になります。省略した場合はすべての行ないしすべての列を指定したことになります。

	> cars[1,]
	  speed dist
	1     4    2
	# carsデータの1-3行のすべての列を抽出
	> cars[1:3,]
	  speed dist
	1     4    2
	2     4   10
	3     7    4
	# carsデータの3行目と6行目の2列目だけを抽出
	> cars[c(3,6), 2]
	[1]  4 10
	# carsデータの3行目と6行目の1-2列目を抽出
	> cars[c(3,6), 1:2]
	  speed dist
	3     7    4
	6     9   10		      

###データフレームの作成

一般にデータフレームは，Excelなどの表計算ソフトで作成したデータを読み込むことで作成されます。ただし，手作業で作成することもできます。利用頻度は低いでしょうが，一応，紹介します。

	> df <- data.frame(X = 1:3, Y = c("A", "B", "C"))
	> df
	  X Y
	1 1 A
	2 2 B
	3 3 C		      
    

data。frame()の丸括弧内に，列名としてXとYを指定して，それぞれ１から３までの整数，文字A,B,Cを変数として含むデータフレーム df を作成しました。

---

## 具体例：誕生月によってJリーガーになりにくくなるのか？
表示されるプロンプトに以下のコマンドを入力し、Rから直接URLを指定してデータをダウンロードし、そのダウンロードしたデータをメモリ上にロード

	> conn <- url("http://euler.bakfoo.com/public/jleagers.rda")
	> load(conn)

すると、data。jleagersというオブジェクトが環境に追加されていることが分かります。
	
	> ls()
	[1] "conn"          "data.jleagers"

このオブジェクトタイプをみると、Rのデータテーブルという表形式であることが分かります。class関数がオブジェクトのタイプを表示します。

	> class(data.jleagers)
	[1] "matrix"
	
誕生月ごとのJリーガーの人数が見えます。これは先ほどのページと同じものです。まずは、これをプロットしてみます。

	> png("test1.png")           # 描画デバイスを開く
	> barplot(data.jleagers)    # 棒グラフ描画
	> dev.off()                 # 描画デバイスを閉じる
	
![img_2-1](img_2-1.png)

###グラフの印象ではなく、定量的に議論する
定量的に調べるには、何かのデータと比較しなければなりません。

ここでは、Jリーガーは圧倒的に日本人が多いということから、日本で出生した人の誕生月分布を利用したいと思います。

	> conn <- url("http://euler.bakfoo.com/public/japanpop.rda")
	> load(conn)
	> ls()
	[1] "conn"          "data.japan"    "data.jleagers"
	> class(data.japan)
	[1] "data.frame"
	> head(data.japan)
	  year   total    jan    feb    mar    apr    may    jun    jul    aug    sep
	1 1947 2678792 295465 226018 235891 209159 195574 194633 226560 236831 231874
	2 1950 2337507 256132 219654 214964 188188 170659 161891 185380 190724 191798
	3 1955 1730692 200116 157071 156751 148066 132368 118513 132759 142036 138323
	4 1960 1606041 166782 142765 149415 144241 126974 115415 125991 129803 128977
	5 1965 1823697 167220 151449 159421 154749 140137 135226 151439 157205 158681
	6 1970 1934239 174550 154966 164241 166087 160860 153129 169825 163974 157094
	     oct    nov    dec
	1 229058 210764 186961
	2 187863 185213 185041
	3 137054 132986 134649
	4 125258 123072 127348
	5 159240 144084 144846
	6 152911 148875 167727

試しに1947年を棒グラフでプロットしたいと思います。

	> jap1947 <- matrix(data.japan[1,3:14], nrow=1, byrow=T) 
	# nrowで行数，ncolで列数を指定する
	# 要素を上の行から順に (左から右へ) 埋める場合は，引数 byrow=T を指定する
	> jap1947
	     [,1]   [,2]   [,3]   [,4]   [,5]   [,6]   [,7]   [,8]   [,9]   [,10]
	[1,] 295465 226018 235891 209159 195574 194633 226560 236831 231874 229058
     [,11]  [,12]
	[1,] 210764 186961	
	> colnames(jap1947) <-c("jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec")
	# 列に名前を設定する
	> jap1947
	     jan    feb    mar    apr    may    jun    jul    aug    sep    oct
	[1,] 295465 226018 235891 209159 195574 194633 226560 236831 231874 229058
	     nov    dec
	[1,] 210764 186961	
	> png("test2.png") 
	> barplot(jap1947)
	> dev.off()
	
![img_2-2](img_2-2.png)

####課題1
2008年のデータを棒グラフでプロットする

####課題2
Jリーガーの現役最年長選手は三浦知良選手と中山雅史選手の1967年生まれで、最年少選手は1993年生まれの月成大輝選手だそうです。この選手はある意味外れ値だとみることにしまして、1975年から1990年までのデータを利用したいと思います。実は先ほどの日本人の誕生日分布のデータは男女を合算したもので、Jリーガーには女性選手はいないという若干の不整合な点があります。そのために、このデータを使うための暗黙の仮定として、女性と男子では月別誕生日分布はそれほど変わらないという仮定を置いています。それでは、データフレームの7行から10行を取り出し、プロットする
（2010年の記事データをそのまま使用しています）

ヒント：apply関数を用いると列方向での処理を行うことができます。

	apply(X, MARGIN, 関数, ...)
	ベクトルや行列，配列の MARGIN に関数を適用し，その結果の配列かリストを返す。
	MARGIN = 1ならば行，MARGIN = 2ならば列，MARGIN = c(1,2)ならば各要素に対して関数を適用

###統計的検定を利用する
統計解析において、ある分布と別の分布が違うことを調べるには<b>「検定」</b>というものを利用します。この場合は「Jリーガーの月別出生数分布は日本人の月別出生数分布と同じである」かどうかを統計学的に検査する。

統計学的に違いを指摘するやり方と、日常生活で違いを指摘するやり方は大分違います。統計学的には検査をしたい仮説を<b>「帰無仮説」（きむかせつ）</b>と呼び、この帰無仮説が統計学的な条件を満たすかどうかという回りくどい検査を行って、違いを指摘することになる。

検定でも、近似的な検定方法であるカイ二乗検定を用いて、「Jリーガーの月別出生数分布は日本人の月別出生数分布と同じである」という帰無仮説の検定を行ないます。それには、chisq.testというRに組み込みのカイ二乗検定関数を利用して、以下のようにします。

	> slice <- 7:10
	> japrecent <- apply(data.japan[slice,], 2, sum)[-c(1,2)]/length(slice)
	> prob <- japrecent/sum(japrecent)
	> chisq.test(data.jleagers,p=prob)

		Chi-squared test for given probabilities

	data:  data.jleagers
	X-squared = 89.5635, df = 11, p-value = 2.03e-14
	
chisq.testの第1引数には「Jリーガーの月別出生数分布」を入れ、第2引数には「日本人の月別出生数分布」を全体の数で割った割合を入れます。第2引数のprob変数には「日本人の月別出生数」を表すjaprecentを、それ自身の和(sum関数を適用してある）で割っています。これは「日本人の月別出生数」の確率密度分布と解釈できます。

この結果を解釈するわけですが、まずはp-valueの数値を見ます。この数値は、第2引数の「日本人の月別出生数分布（の確率密度）」を仮定する場合、第1引数の「Jリーガーの月別出生数分布」が実現する確率はどのくらいか、を表しています。その確率は2.031e-14（10のマイナス14乗）という非常に低い確率になるということです。つまり、このような低い確率では帰無仮説である「Jリーガーの月別出生数分布は日本人の月別出生数分布と同じである」という言明は採用できない、<b>棄却</b>できる、ということです。日本人の出生数分布とJリーガーの出生数分布は異なっているので、Jリーガーになるためには何らかの理由が働いてそうだ、誕生月によってJリーガーになりにくいということがありそうだ、ということが言えそうです。

###カイ二乗検定の原理
次の数学定理が成り立っていることが、カイ二乗適合度検定が成立する根拠になっている。

<b>定理</b>

　カテゴリ数がk、あるカテゴリiに該当する観測度数をniそのカテゴリの期待度数をeiとするときに、以下の確率変数x^2
　

　
![img_2-3](img_2-3.gif)


の分布が、サンプル数を十分に大きくしたときに自由度k-1のカイ二乗分布に近づく。

ここで「カテゴリ」とは、サンプルをとるときの区分けのことです。例えばいままで話題にしてきたJリーガーの月別出生数の場合、data.jleagersにある、jan,、feb、mar……、という誕生月に区分けをして出生数を数えますので、誕生月がカテゴリになります。

証明はしない代わりに、定理の意味を簡潔に説明したいと思います。

　まず、定理にあるx^2とは、カテゴリiごとの観測度数と期待度数の差の相対値、




![img_2-4](img_2-4.gif)



を、すべてのカテゴリについて足し合わせたものです。つまり、このx^2値は観測した分布が、期待している分布に比べてどれだけ類似しているかを表す値です。

　このために、x^2が、自由度k-1のカイ二乗分布を仮定したときに、カイ二乗分布の確率として十分に小さな値をとるか、つまり観測した分布と期待している分布がどの程度の確率で同じであるかどうか、ということが検査の基準になります。


###有意水準、p値
一般に、確率密度分布が分かっている確率変数がある場合、その確率変数に範囲を与えれば、その範囲の積分することにより確率を求めることができます。

　例えば自由度1のカイ二乗分布の場合、定義域が0から3.84までの値、つまり0から破線までの範囲を積分すると、その値は青い領域になり、約0.95、つまり確率は約95％になります。

このことは、確率密度がカイ二乗分布を持つ確率変数を考えたときに、無作為に選んだその確率変数の値がx=0からx=3.84の間に含まれる確率は、約95％になると言い換えることができる。これはカイ二乗密度分布から確率を計算するRの組み込み関数pchisqで以下のように計算ができます。

	> pchisq(3.84, 1)
	[1] 0.9499565

　このことを逆に考えますと、確率密度がカイ二乗分布を持つ確率変数を考えたときに、無作為に選んだその確率変数の値がx=0からx=3.84の間に含まれない確率は、全確率から0.95を引いた値、「1-0.95 = 0.05」、つまり約5％残っている。
　
統計的検定をする確率変数は、帰無仮説を元に計算した統計量です。いま考えている例は、観測した分布と期待している分布の類似の程度を表わすx2でした。この帰無仮説を元に計算した統計量と、無作為に選んだ確率変数が存在する「ある確率水準」を比べることが、統計的検定では決定的に重要になります。この判定の基準となる「ある確率水準」を全確率1から引いたものを有意水準と呼びます。

　有意水準は、統計的検定を行う分野で使われている基準がなければ、5％や1％を慣習的として採用する場合が多いようです。上記の例では5％有意水準をとった図を描いたことになります。つまり、無作為に選んだ確率変数が青の領域にいる確率は95％ですが、赤の領域にいる確率は5％ということです。そして、帰無仮説を元に計算した統計量が有意水準にいる、つまり赤の領域にいるかどうかというので、統計的検定を行います。赤の領域というのは、無作為で選んだ確率変数が存在する確率が5％（や1％などの）有意水準であり、なかなか状況として起こりにくいということです。帰無仮説を元に計算した統計量がこの赤の領域に入るということは、その統計量は実現しにくい、すなわち帰無仮説を支持することが難しいということになります。

　もう一度定理に戻ります。カイ二乗適合度の定理は、観測から求めることができる確率変数x2が、十分に観測のサンプル数が大きい場合にカイ二乗分布と近似できるというものでした。そして、このx2という値は、観測した分布と期待している分布の類似の程度のようなものでした。その類似の程度が赤の領域にあるということは、その類似の程度は確率的に起こるのが難しいということになり、観測した分布と期待している分布が同じとはいえない、ことが言えます。

　そこで実務者としてやるべきことは、観測した分布と期待している分布の類似の程度を表すx2の値を計算し、それが自由度k-1のカイ二乗分布のどの位置に該当するか調べ、その位置が有意水準に含まれるかどうかを見ればいいわけです。

　ここでは、この一連の手順をchisq.test関数を使うのではなく、実際にx2の値を計算することで原理を明らかにします。では計算してみましょう。
　
　ここでは、この一連の手順をchisq.test関数を使うのではなく、実際にx2の値を計算することで原理を明らかにします。では計算してみましょう。
　

	> jcount <- data.jleagers
	> xsq <- sum((jcount-sum(jcount)*prob)^2/(sum(jcount)*prob))
	> xsq
	[1] 89.56353
	
　jcountにはJリーガーの月別出生数が入っていて、probには日本人の月別出生比率（母比率といいます）が入っています。sum(jcount)*probは月別出生数の期待度数を計算しているところです。さて、このxsqがカイ二乗分布においてどの程度の確率を占めるかを調べるには、pchisqを利用します。そして、この場合のカイ二乗分布の自由度とは、月数12から1を引いた11になります。これは、カイ二乗分布の自由度は一様分布を仮定するとき、定理にあるように、カテゴリ数をkとしてときにk-1になるからです（ここで実は、若干の不整合があります。前回書きましたように、実は日本人の月別出生分布は正確には一様分布でありません。従って、本当は自由度を別途計算しなければなりません。しかし、この値は影響範囲が小さいのでこのまま近似的に成り立つとします）。

	> 1-pchisq(xsq,11)
	[1] 2.031708e-14

　この値を統計量^x2のp値といいます。この値はchisq.testのp-valueと同じ結果であることがわかります。p値の計算式を見ると分かるように、これは検定するべき統計量が取る値およびそれ以上の値を取る確率を表しています。p値は帰無仮説が正しいとして、検定するべき統計量の値と、それより起こりそうもない値がどれだけの割合で出現するかを示すものです。p値を利用すれば、有意水準と直接比較することができます。ですから、前回はp-valueの値をみて、すぐに帰無仮説が棄却できるかどうかを判断したのです。

###統計的検定ということ
　いままでやってきた、適合度のカイ二乗検定をまとめると、以下のとおりです。

* 有意水準を設定する
* 帰無仮説を立てる。帰無仮説は本来示したいことの反対の言明
* 帰無仮説が正しいとして、そのときの統計量x2を計算する
* x^2のp値は有意水準より小さいか？ つまり、帰無仮説を元にしたx^2は起こりにくい値か？
* p値が有意水準より小さい場合：帰無仮説を棄却する
* p値が有意水準より大きい場合：帰無仮説は棄却できない

　ここで注意することは、帰無仮説が棄却できない場合、帰無仮説が正しいとするのは、正確には間違いだということです。そうではなく、帰無仮説を正しいとするにはデータが十分でない、と控えめに言わなければなりません。そもそも、本来示したい言明ではなく、その反対の言明である帰無仮説を立てて、帰無仮説を反証するというやり方も、日常的な感覚からすると、かなりひねくれたやり方である。